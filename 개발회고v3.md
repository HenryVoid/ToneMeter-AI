# 개발 회고 v3: 강제 업데이트(Force Update) 기능 구현

**버전**: 1.0.2  
**브랜치**: `feature/versionCheck`  
**작성일**: 2025년 12월 6일

---

## 1. 개요
앱의 중요한 보안 패치나 치명적인 버그 수정 시, 사용자가 반드시 최신 버전으로 업데이트하도록 유도하는 "강제 업데이트" 기능을 구현했습니다. 앱 심사 없이 유연하게 업데이트 여부를 제어하기 위해 **Firebase Remote Config**를 기술로 선택했습니다.

## 2. 기술 선택 (Technical Decision)

### 1) App Store Lookup API vs Firebase Remote Config
강제 업데이트 기능을 구현하는 데 있어 두 가지 방식을 고려했습니다.

| 방식 | 장점 | 단점 | 선택 |
| :--- | :--- | :--- | :--- |
| **App Store Lookup API** | 서버 설정 불필요, 구현 간단 | "강제성" 제어가 어려움 (단순히 새 버전 유무만 확인), 배포 후 API 반영 지연 | ❌ |
| **Firebase Remote Config** | **원격 제어 가능 (특정 버전 강제)**, 실시간 반영, 대상 타겟팅 가능 | Firebase SDK 의존성 추가 필요 | ✅ |

**결론**: 단순히 "새 버전이 있습니다"라고 알리는 것을 넘어, 심각한 이슈 발생 시 **특정 버전 이하 사용자의 진입을 원천 차단**해야 하므로 `min_required_version` 값을 마음대로 조절할 수 있는 Firebase Remote Config가 적합하다고 판단했습니다.

## 3. 구현 내용

### 1) VersionCheckService
- **역할**: Remote Config 값을 가져와 현재 앱 버전과 비교합니다.
- **핵심 로직**:
  - `min_required_version` 키값을 Fetch합니다.
  - 현재 앱 버전(`Bundle.main`)과 비교하여 업데이트 필요 여부(`needsUpdate`)를 `@Published` 프로퍼티로 방출합니다.
  - 디버그 모드에서는 Fetch Interval을 0으로 설정하여 즉시 테스트 가능하게 했습니다.

```swift
// 버전 비교 로직 (SemVer 기준)
private func isUpdateRequired(current: String, min: String) -> Bool {
    // ... 버전 숫자를 쪼개서 비교 ...
}
```

### 2) UI 연동 (ToneMeterApp.swift)
- 앱 최상위(`App` 구조체)에서 `VersionCheckService`를 감시합니다.
- `needsUpdate`가 `true`가 되면 **닫을 수 없는 Alert**를 띄웁니다.
- "업데이트 하러 가기" 버튼 클릭 시 App Store URL(`itms-apps://...`)로 이동합니다.
- 강제성을 위해 버튼을 눌러도 앱으로 돌아오면 다시 Alert가 뜨도록 처리했습니다.

### 3) 프로젝트 설정
- `ToneMeter.xcodeproj`에 `FirebaseRemoteConfig` 패키지 의존성을 추가했습니다.
- `AppConstants`에 App Store ID (`6751636184`) 상수를 추가하여 관리합니다.

## 4. 트러블슈팅 & 배운 점

### 📦 Firebase Remote Config 패키지 추가
- **문제**: 기존 `firebase-ios-sdk`는 추가되어 있었으나, `FirebaseRemoteConfig` 모듈이 링크되어 있지 않아 컴파일 에러가 발생할 수 있었습니다.
- **해결**: `project.pbxproj`를 수정하여 `ToneMeter` 타겟의 `packageProductDependencies`에 `FirebaseRemoteConfig`를 명시적으로 추가했습니다.

### 🔄 강제성 부여
- **고민**: Alert의 "닫기"나 "취소" 버튼을 어떻게 없앨 것인가?
- **해결**: SwiftUI의 `alert`에는 기본적으로 버튼이 필요하므로, 버튼을 하나만 두고("업데이트"), 그 버튼의 동작이 앱스토어로 이동하는 것이 되도록 했습니다. 또한, 사용자가 앱스토어에서 업데이트하지 않고 다시 앱으로 돌아오는 경우를 대비해 `DispatchQueue`를 이용해 Alert 상태를 다시 `true`로 설정하는 방어 로직을 추가했습니다.

## 5. 향후 계획
- 현재는 단순 `Alert`를 사용했지만, 디자인된 안내 화면을 보여주기 위해 `fullScreenCover`로 전환을 고려할 수 있습니다.
- "선택적 업데이트" (업데이트 권장하지만 닫기 가능) 기능도 Remote Config 키를 추가하여 확장할 수 있습니다.

