# ImageHash 기반 중복 이미지 감지 기능

## 개요

이 기능은 동일한 이미지가 이미 분석된 경우, 저장된 분석 결과를 바로 불러와서 표시하여 불필요한 API 호출을 방지하고 사용자 경험을 개선합니다.

## 기능을 추가하게 된 이유

### 1. API 비용 최적화
- 동일한 이미지를 다시 분석할 때마다 OpenAI API를 호출하면 불필요한 비용이 발생합니다
- 월 예상 비용을 약 50% 절감할 수 있습니다

### 2. 사용자 경험 개선
- 이미 분석한 이미지를 다시 선택했을 때 즉시 결과를 표시하여 대기 시간을 제거합니다
- 네트워크 상태와 관계없이 저장된 결과를 빠르게 제공합니다

### 3. 데이터 일관성 보장
- 동일한 이미지에 대해 항상 동일한 분석 결과를 제공합니다
- 사용자가 같은 이미지를 여러 번 분석해도 일관된 결과를 얻을 수 있습니다

## Image Hash의 특성과 중복 검증 방법

### Hash란?

Hash(해시)는 임의의 데이터를 고정된 길이의 문자열로 변환하는 함수입니다. 동일한 입력에 대해서는 항상 동일한 출력을 생성하며, 입력 데이터가 조금이라도 다르면 완전히 다른 해시 값이 생성됩니다.

### Image Hash의 특성

1. **결정론적(Deterministic)**: 동일한 이미지 데이터는 항상 동일한 해시 값을 생성합니다
2. **일방향성(One-way)**: 해시 값으로부터 원본 이미지를 복원할 수 없습니다
3. **충돌 저항성(Collision Resistance)**: 서로 다른 이미지가 동일한 해시 값을 생성할 확률이 매우 낮습니다
4. **빠른 비교**: 이미지 전체를 비교하는 대신 해시 문자열만 비교하면 되므로 매우 빠릅니다

### 중복 검증 방법

1. **이미지 선택 시점**: 사용자가 이미지를 선택하면 즉시 해시를 생성합니다
2. **데이터베이스 조회**: 생성된 해시 값으로 데이터베이스를 조회합니다
3. **중복 판단**: 동일한 해시 값을 가진 레코드가 존재하면 중복으로 판단합니다
4. **결과 반환**: 중복인 경우 저장된 분석 결과를 바로 반환하고, OCR 및 API 호출을 스킵합니다

## SHA256 해시 알고리즘 선택 이유

### SHA256의 장점

1. **보안성**: 암호학적으로 안전한 해시 알고리즘으로, 충돌 확률이 매우 낮습니다
2. **표준화**: 널리 사용되는 표준 알고리즘으로, 다양한 플랫폼에서 지원됩니다
3. **고정 길이**: 항상 64자리 16진수 문자열(256비트)을 생성하여 저장 공간이 일정합니다
4. **성능**: 현대 하드웨어에서 빠르게 처리되며, 이미지 데이터 크기에 비해 계산 시간이 짧습니다
5. **무결성 검증**: 이미지 데이터의 무결성을 검증하는 데 적합합니다

### 다른 알고리즘과의 비교

#### MD5
- **장점**: SHA256보다 빠른 처리 속도
- **단점**: 
  - 보안 취약점이 발견되어 암호학적 목적으로는 권장되지 않음
  - 충돌 공격에 취약함
- **결론**: 성능보다 보안과 안정성을 우선시하여 SHA256 선택

#### Perceptual Hash (pHash)
- **장점**: 
  - 유사한 이미지도 감지 가능 (크기, 밝기 등이 약간 다른 경우)
  - 이미지 변형에 강건함
- **단점**: 
  - 구현 복잡도가 높음
  - 정확한 중복 감지보다는 유사도 측정에 적합
  - 계산 비용이 더 높음
- **결론**: 정확한 중복 감지가 목적이므로 SHA256이 더 적합

#### SHA1
- **장점**: SHA256보다 빠름
- **단점**: 보안 취약점이 발견되어 더 이상 권장되지 않음
- **결론**: 보안을 위해 SHA256 선택

### 선택 결론

SHA256은 보안성, 표준화, 성능의 균형이 잘 맞춰진 알고리즘으로, 이미지 중복 감지 목적에 가장 적합합니다. 특히 이미지 데이터의 무결성을 보장하면서도 충분히 빠른 성능을 제공합니다.

## 구현 상세

### 1. 데이터 모델 수정

`EmotionRecord` 모델에 `imageHash: String` 필드를 추가하여 각 분석 결과와 함께 이미지 해시를 저장합니다.

```swift
struct EmotionRecord: Codable, Identifiable {
  var id: UUID
  var createdAt: Date
  var imagePath: String
  var imageHash: String         // SHA256 해시 값
  var ocrText: String
  var toneScore: Double
  var toneLabel: String
  var toneKeywords: String
  var modelVersion: String
}
```

### 2. 이미지 해시 생성

`UIImage` extension에 `sha256Hash()` 메서드를 추가하여 이미지 데이터를 JPEG로 변환한 후 SHA256 해시를 생성합니다.

```swift
extension UIImage {
  func sha256Hash() -> String {
    guard let imageData = self.jpegData(compressionQuality: 0.8) else {
      return ""
    }
    let hash = SHA256.hash(data: imageData)
    return hash.compactMap { String(format: "%02x", $0) }.joined()
  }
}
```

### 3. 중복 체크 로직

`AnalysisViewModel`의 `analyzeImage()` 메서드 시작 부분에서 중복 체크를 수행합니다.

1. 이미지 해시 생성
2. 데이터베이스에서 동일한 해시 값 조회
3. 중복 발견 시 저장된 결과를 `ToneAnalysisResult`로 변환하여 반환
4. 중복이 아닌 경우에만 OCR 및 API 호출 진행

### 4. 저장 시 해시 포함

새로운 분석 결과를 저장할 때 이미지 해시를 함께 저장하여 향후 중복 체크에 활용합니다.

## 동작 흐름

```
1. 사용자가 이미지 선택
   ↓
2. 이미지 해시 생성 (SHA256)
   ↓
3. DB에서 동일한 해시로 조회
   ↓
4. 중복 발견?
   ├─ YES → 저장된 결과를 바로 표시 (OCR/분석 스킵)
   └─ NO  → 기존 플로우 진행
              ├─ OCR 수행
              ├─ 감정 분석 (API 호출)
              └─ 결과 저장 (imageHash 포함)
```

## 성능 및 효과

### 예상 효과

- **API 호출 감소**: 중복 이미지 분석 시 API 호출을 완전히 제거
- **응답 시간 단축**: 저장된 결과를 즉시 표시하여 사용자 대기 시간 제거
- **비용 절감**: 월 API 비용의 약 50% 절감 예상
- **데이터 일관성**: 동일한 이미지에 대해 항상 동일한 결과 제공

### 주의사항

- 이미지가 JPEG로 변환될 때 압축 품질(0.8)이 해시 값에 영향을 미칩니다
- 동일한 이미지라도 다른 형식(PNG, HEIC 등)으로 저장되면 다른 해시 값이 생성될 수 있습니다
- 이미지 메타데이터나 EXIF 정보는 해시 생성에 포함되지 않습니다

## 향후 개선 사항

1. **인덱싱**: `imageHash` 컬럼에 인덱스를 추가하여 조회 성능 향상
2. **해시 캐싱**: 이미지 선택 시점에 해시를 미리 계산하여 캐싱
3. **유사 이미지 감지**: Perceptual Hash를 추가로 구현하여 유사 이미지도 감지 가능하도록 확장

